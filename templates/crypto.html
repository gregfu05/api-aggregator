{% extends "_base.html" %}
{% block content %}
<p>Search a crypto by name or symbol (e.g. <code>bitcoin</code>, <code>ethereum</code>). Suggestions use CoinGecko’s coin list.</p>

<form action="/crypto" method="get" class="rel" autocomplete="off">
  <div class="rel" style="flex:1">
    <input id="crypto-input" type="text" name="symbol" value="{{ symbol }}" placeholder="bitcoin">
    <ul id="crypto-suggest" class="suggest" style="display:none"></ul>
  </div>
  <button type="submit">Search</button>
</form>

{% if error %}<div class="err">⚠️ {{ error }}</div>{% endif %}

{% if result %}
<div class="card" style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; align-items:start;">
  <div>
    <h3>Result</h3>
    <div><strong>Timestamp:</strong> {{ result.timestamp }}</div>
    <div><strong>Cache:</strong> {{ result.meta.cache }}</div>
    <table>
      <thead><tr><th>Symbol</th><th>Type</th><th>Price</th><th>Source</th><th>As Of</th></tr></thead>
      <tbody>
        {% for a in result.assets %}
        <tr><td>{{ a.symbol }}</td><td>{{ a.type }}</td><td>{{ "%.6f"|format(a.price) }}</td><td>{{ a.source }}</td><td>{{ a.asOf }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="chartBox" style="display:none">
    <h3>Last 30 days</h3>
    <canvas id="cryptoChart" height="120"></canvas>
  </div>
</div>
{% endif %}

<script>
/* --- suggestions --- */
const inp = document.getElementById('crypto-input');
const box = document.getElementById('crypto-suggest');
let t;
inp?.addEventListener('input', async () => {
  clearTimeout(t);
  const q = inp.value.trim();
  if(!q){ box.style.display='none'; box.innerHTML=''; return; }
  t = setTimeout(async () => {
    const res = await fetch(`/suggest/crypto?q=${encodeURIComponent(q)}`);
    const items = await res.json();
    if(!Array.isArray(items) || items.length===0){ box.style.display='none'; box.innerHTML=''; return; }
    box.innerHTML = items.map(i => `<li data-id="${i.id}">${i.name} (${i.symbol})</li>`).join('');
    box.style.display='block';
    [...box.querySelectorAll('li')].forEach(li => {
      li.onclick = () => { inp.value = li.dataset.id; box.style.display='none'; };
    });
  }, 200);
});
document.addEventListener('click', (e)=>{ if(!box.contains(e.target) && e.target!==inp){ box.style.display='none'; }});

/* --- chart --- */
async function drawCryptoChart(coinId){
  try{
    const res = await fetch(`/history/crypto?id=${encodeURIComponent(coinId)}&days=30`);
    const data = await res.json();
    if(!data.series || !data.series.length) return;
    const labels = data.series.map(p => new Date(p.t));
    const values = data.series.map(p => p.y);
    const ctx = document.getElementById('cryptoChart').getContext('2d');
    window._cryptoChart && window._cryptoChart.destroy();
    window._cryptoChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: coinId,
          data: values,
          borderWidth: 2,
          borderColor: 'blue',
          backgroundColor: 'rgba(0,0,255,0.08)',
          pointRadius: 0,
          tension: 0.2,
        }]
      },
      options: {
        scales: {
          x: { type: 'time', time: { unit: 'day' } },
          y: { beginAtZero: false }
        },
        plugins: { legend: { display: false } }
      }
    });
    document.getElementById('chartBox').style.display = 'block';
  }catch(e){}
}
</script>

{# Only emit the call when we actually have a crypto result #}
{% if result and result.assets and result.assets[0].type == 'crypto' %}
<script>
  drawCryptoChart('{{ result.assets[0].symbol | e }}');
  document.getElementById('chartBox').style.display = 'block';
</script>
{% endif %}

{% endblock %}